# Система лицензирования Shuffle

Этот документ описывает систему лицензирования, реализованную для платформы автоматизации Shuffle.

## Обзор

Система лицензирования обеспечивает контроль доступа к функциям платформы на основе типа и статуса лицензии. Она включает в себя:

- Генерацию и управление лицензионными ключами
- Активацию лицензий
- Проверку лимитов и ограничений
- Middleware для защиты API endpoints
- Пользовательский интерфейс для управления лицензиями

## Типы лицензий

### Basic (Базовая)
- **Пользователи**: До 3
- **Workflow'ы**: До 5
- **Выполнения**: До 1000 в месяц
- **Приложения**: Базовый набор
- **Поддержка**: Сообщество

### Professional (Профессиональная)
- **Пользователи**: До 10
- **Workflow'ы**: До 50
- **Выполнения**: До 10000 в месяц
- **Приложения**: Все доступные
- **Поддержка**: Email
- **Дополнительно**: Расширенные интеграции, базовая отчетность

### Enterprise (Корпоративная)
- **Пользователи**: Без ограничений
- **Workflow'ы**: Без ограничений
- **Выполнения**: Без ограничений
- **Приложения**: Все доступные
- **Поддержка**: Приоритетная
- **Дополнительно**: SSO, аудит, кастомный брендинг, расширенная отчетность

## Архитектура

### Backend компоненты

1. **license.go** - Основная логика лицензирования
   - Структуры данных для лицензий
   - Функции создания, активации и валидации
   - API endpoints для управления лицензиями
   - Middleware для проверки лицензий

2. **license_generator.go** - CLI инструмент для генерации лицензий
   - Генерация новых лицензионных ключей
   - Валидация существующих ключей
   - Просмотр информации о лицензиях

### Frontend компоненты

1. **LicenseManager.jsx** - Основной компонент управления лицензиями
   - Отображение информации о текущей лицензии
   - Активация новых лицензий
   - Просмотр лимитов и функций

2. **LicenseWarning.jsx** - Компонент предупреждений
   - Уведомления об истечении лицензии
   - Предупреждения о превышении лимитов
   - Призывы к действию для обновления лицензии

## API Endpoints

### POST /api/v1/license/generate
Создает новую лицензию (только для администраторов).

**Запрос:**
```json
{
  "type": "professional",
  "organization_id": "org-123",
  "duration": 365
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "License generated successfully",
  "license": {
    "id": "lic-456",
    "key": "ABCD1234-EFGH5678-IJKL9012-MNOP3456",
    "type": "professional",
    "status": "active",
    "expires_at": "2024-12-31T23:59:59Z",
    "max_users": 10,
    "max_workflows": 50,
    "max_executions": 10000,
    "features": ["workflows:50", "users:10", ...]
  }
}
```

### POST /api/v1/license/activate
Активирует лицензию для организации.

**Запрос:**
```json
{
  "key": "ABCD1234-EFGH5678-IJKL9012-MNOP3456",
  "hardware_id": "optional-hardware-id"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "License activated successfully",
  "license": { ... }
}
```

### GET /api/v1/license/info
Получает информацию о текущей лицензии организации.

**Ответ:**
```json
{
  "success": true,
  "message": "License information retrieved successfully",
  "license": { ... }
}
```

## CLI инструмент

### Генерация лицензии
```bash
cd backend/go-app
SHUFFLE_LICENSE_STANDALONE=true go run license_generator.go -generate -type professional -duration 365
```

### Валидация лицензии
```bash
SHUFFLE_LICENSE_STANDALONE=true go run license_generator.go -validate ABCD1234-EFGH5678-IJKL9012-MNOP3456
```

### Помощь
```bash
go run license_generator.go -help
```

## Middleware защита

Система автоматически защищает критические API endpoints:

```go
// Создание workflow'ов требует проверки лимита
r.HandleFunc("/api/v1/workflows", checkLicenseMiddleware(shuffle.SetNewWorkflow, "workflows"))

// Выполнение workflow'ов требует проверки лимита выполнений
r.HandleFunc("/api/v1/workflows/{key}/run", checkLicenseMiddleware(executeWorkflow, "executions"))

// Регистрация пользователей требует проверки лимита пользователей
r.HandleFunc("/api/v1/users/register", checkLicenseMiddleware(handleRegister, "users"))
```

## Хранение данных

### Cloud окружение
Лицензии хранятся в Google Datastore с индексацией по:
- `organization_id`
- `key`
- `status`
- `created_at`

### On-premise окружение
Лицензии хранятся в JSON файлах в директории `/tmp/`:
- Формат: `/tmp/shuffle_license_{license_id}.json`
- Рекомендуется настроить резервное копирование

## Безопасность

1. **Генерация ключей**: Использует криптографически стойкий генератор случайных чисел
2. **Hardware ID**: Привязка лицензии к конкретному оборудованию
3. **Валидация**: Регулярная проверка срока действия и статуса
4. **API защита**: Middleware проверяет лицензию перед выполнением операций

## Мониторинг и алерты

Система автоматически:
- Отслеживает приближение срока истечения лицензии
- Предупреждает о превышении лимитов
- Логирует попытки использования функций без лицензии
- Отображает статус лицензии в интерфейсе

## Интеграция с существующим кодом

### Проверка функций
```go
if CheckLicenseFeature(ctx, organizationID, "sso") {
    // Включить SSO функциональность
}
```

### Проверка лимитов
```go
limit := GetLicenseLimit(ctx, organizationID, "workflows")
if limit > 0 && currentCount >= limit {
    return errors.New("workflow limit exceeded")
}
```

### Frontend предупреждения
```jsx
import LicenseWarning from './components/LicenseWarning';

// В компоненте
<LicenseWarning
  message="Для создания workflow'ов требуется активная лицензия"
  onLicenseActivate={() => setShowLicenseManager(true)}
/>
```

## Развертывание

1. **Backend**: Убедитесь, что файлы `license.go` и `license_generator.go` включены в сборку
2. **Frontend**: Добавьте компоненты лицензирования в routing
3. **База данных**: Создайте индексы для Datastore (если используется)
4. **Конфигурация**: Установите переменные окружения для Cloud/On-premise режима

## Устранение неполадок

### Лицензия не активируется
- Проверьте правильность ключа
- Убедитесь, что лицензия не истекла
- Проверьте, не активирована ли лицензия на другом оборудовании

### API возвращает ошибку лицензии
- Проверьте статус лицензии через `/api/v1/license/info`
- Убедитесь, что middleware правильно настроен
- Проверьте логи для деталей ошибки

### Лимиты не работают
- Убедитесь, что функция `checkLicenseLimits` вызывается
- Проверьте правильность подсчета текущего использования
- Убедитесь, что лицензия содержит правильные лимиты

## Расширение системы

Для добавления новых типов лицензий:

1. Обновите `LicenseFeatures` в `license.go`
2. Добавьте соответствующие переводы в `i18n.js`
3. Обновите UI компоненты для отображения новых функций
4. Добавьте проверки новых функций в middleware

Для добавления новых лимитов:

1. Добавьте поля в структуру `License`
2. Обновите функцию `checkLicenseLimits`
3. Добавьте проверки в соответствующие API endpoints
4. Обновите UI для отображения новых лимитов